<!DOCTYPE html>
<!-- saved from url=(0161)https://us1a.app.anaplan.com/core3333/anaplan/framework.jsp?selectedWorkspaceId=8a81b08e5054334f01514272df446a5f&selectedModelId=3E00E4D9C8CD408DBFDECF22548BAB7D -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>Anaplan - Chrome Extension</title>
    <link rel="dns-prefetch" href="https://fonts.googleapis.com/">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <link href="./Anaplan - Chrome Extension_files/styles.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 9]>
    <link href="lib-732437e2-1cc5-494f-9f51-b1908c9e7869/dormouse/ie/styles.css" rel="stylesheet" type="text/css" />
    <![endif]-->
    
    <link href="./Anaplan - Chrome Extension_files/modern-blessed1.css" rel="stylesheet" type="text/css">
    <link href="./Anaplan - Chrome Extension_files/modern.css" rel="stylesheet" type="text/css">
    
    <link href="./Anaplan - Chrome Extension_files/feature-styling.css" rel="stylesheet" type="text/css">

    
    
    <link href="./Anaplan - Chrome Extension_files/global-nav.css" rel="stylesheet" type="text/css">
    

    <style type="text/css">
        html, body, #border {
            width: 100%;
            height: 100%;
            overflow: auto;
            overflow-x: hidden;
            position: absolute;
        }
        @media print {
            html, body {
                position: relative;
            }
        }
    </style>
<script src="http://code.jquery.com/jquery-3.3.1.min.js"integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" href="./Anaplan - Chrome Extension_files/dgrid.css">
</head>

<body class="claro original">

<table class="formulaEditorTable formulaEditorExpressionTable">
  <tbody>
    <tr>
      <td class="formulaEditorExpressionCell">
          <code id="formated_text" style="" contenteditable="true">This is formatted text</code>
          <textarea rows="1" class="formulaEditorText" data-dojo-attach-point="formula" data-dojo-attach-event="ondblclick:_onDoubleClick,onkeypress:_onKeyPress,onkeydown:_onKeyDown,onmouseup:_setInputSelection,onfocus:_setInputSelection,onkeyup:_setInputSelection"></textarea>
      </td>
      <td class="formulaEditorToolbar" wairole="toolbar" data-dojo-attach-point="containerNode,toolbar"><span class="dijit dijitReset dijitInline dijitButton" role="presentation" widgetid="uniqName_5_51"><span class="dijitReset dijitInline dijitButtonNode" data-dojo-attach-event="ondijitclick:__onClick" role="presentation"><span class="dijitReset dijitStretch dijitButtonContents" data-dojo-attach-point="titleNode,focusNode" role="button" aria-labelledby="uniqName_5_51_label" id="uniqName_5_51" title="Display help in new tab" tabindex="-1" aria-disabled="false" style="user-select: none;"><span class="dijitReset dijitInline dijitIcon anaplanEditorIcon anaplanEditorIconHelp" data-dojo-attach-point="iconNode"></span><span class="dijitReset dijitToggleButtonIconChar">●</span><span class="dijitReset dijitInline dijitButtonText dijitDisplayNone" id="uniqName_5_51_label" data-dojo-attach-point="containerNode">Display help in new tab</span></span></span><input type="button" value="" class="dijitOffScreen" data-dojo-attach-event="onclick:_onClick" tabindex="-1" role="presentation" aria-hidden="true" data-dojo-attach-point="valueNode"></span><span class="dijit dijitReset dijitInline dijitButton" role="presentation" widgetid="uniqName_5_52"><span class="dijitReset dijitInline dijitButtonNode" data-dojo-attach-event="ondijitclick:__onClick" role="presentation"><span class="dijitReset dijitStretch dijitButtonContents" data-dojo-attach-point="titleNode,focusNode" role="button" aria-labelledby="uniqName_5_52_label" id="uniqName_5_52" title="/" tabindex="-1" aria-disabled="false" style="user-select: none;"><span class="dijitReset dijitInline dijitIcon anaplanEditorIcon anaplanEditorIconDivide" data-dojo-attach-point="iconNode"></span><span class="dijitReset dijitToggleButtonIconChar">●</span><span class="dijitReset dijitInline dijitButtonText dijitDisplayNone" id="uniqName_5_52_label" data-dojo-attach-point="containerNode">/</span></span></span><input type="button" value="" class="dijitOffScreen" data-dojo-attach-event="onclick:_onClick" tabindex="-1" role="presentation" aria-hidden="true" data-dojo-attach-point="valueNode"></span><span class="dijit dijitReset dijitInline dijitButton" role="presentation" widgetid="uniqName_5_53"><span class="dijitReset dijitInline dijitButtonNode" data-dojo-attach-event="ondijitclick:__onClick" role="presentation"><span class="dijitReset dijitStretch dijitButtonContents" data-dojo-attach-point="titleNode,focusNode" role="button" aria-labelledby="uniqName_5_53_label" id="uniqName_5_53" title="*" tabindex="-1" aria-disabled="false" style="user-select: none;"><span class="dijitReset dijitInline dijitIcon anaplanEditorIcon anaplanEditorIconMultiply" data-dojo-attach-point="iconNode"></span><span class="dijitReset dijitToggleButtonIconChar">●</span><span class="dijitReset dijitInline dijitButtonText dijitDisplayNone" id="uniqName_5_53_label" data-dojo-attach-point="containerNode">*</span></span></span><input type="button" value="" class="dijitOffScreen" data-dojo-attach-event="onclick:_onClick" tabindex="-1" role="presentation" aria-hidden="true" data-dojo-attach-point="valueNode"></span><span class="dijit dijitReset dijitInline dijitButton" role="presentation" widgetid="uniqName_5_54"><span class="dijitReset dijitInline dijitButtonNode" data-dojo-attach-event="ondijitclick:__onClick" role="presentation"><span class="dijitReset dijitStretch dijitButtonContents" data-dojo-attach-point="titleNode,focusNode" role="button" aria-labelledby="uniqName_5_54_label" id="uniqName_5_54" title="-" tabindex="-1" aria-disabled="false" style="user-select: none;"><span class="dijitReset dijitInline dijitIcon anaplanEditorIcon anaplanEditorIconMinus" data-dojo-attach-point="iconNode"></span><span class="dijitReset dijitToggleButtonIconChar">●</span><span class="dijitReset dijitInline dijitButtonText dijitDisplayNone" id="uniqName_5_54_label" data-dojo-attach-point="containerNode">-</span></span></span><input type="button" value="" class="dijitOffScreen" data-dojo-attach-event="onclick:_onClick" tabindex="-1" role="presentation" aria-hidden="true" data-dojo-attach-point="valueNode"></span><span class="dijit dijitReset dijitInline dijitButton" role="presentation" widgetid="uniqName_5_55"><span class="dijitReset dijitInline dijitButtonNode" data-dojo-attach-event="ondijitclick:__onClick" role="presentation"><span class="dijitReset dijitStretch dijitButtonContents" data-dojo-attach-point="titleNode,focusNode" role="button" aria-labelledby="uniqName_5_55_label" id="uniqName_5_55" title="+" tabindex="-1" aria-disabled="false" style="user-select: none;"><span class="dijitReset dijitInline dijitIcon anaplanEditorIcon anaplanEditorIconPlus" data-dojo-attach-point="iconNode"></span><span class="dijitReset dijitToggleButtonIconChar">●</span><span class="dijitReset dijitInline dijitButtonText dijitDisplayNone" id="uniqName_5_55_label" data-dojo-attach-point="containerNode">+</span></span></span><input type="button" value="" class="dijitOffScreen" data-dojo-attach-event="onclick:_onClick" tabindex="-1" role="presentation" aria-hidden="true" data-dojo-attach-point="valueNode"></span></td>
    </tr>
  </tbody>
</table>
<style>
    #formated_text {font-size: 20px;}
    .rsm-highlight {font-weight: bold}

    .rsm-bracket-wrong {color: #f00;font-weight: 900;}
    .rsm-bracket-0 {color: green;}
    .rsm-bracket-1 {color: yellow;}
    .rsm-bracket-2 {color: brown;}
    .rsm-bracket-3 {color: magenta;}
    .rsm-bracket-4 {color: purple;}

    .rsm-ite-0 {color: #0070c0;}
    .rsm-ite-1 {color: #7030a0;}
    .rsm-ite-2 {color: #00B0F0;}
    .rsm-ite-3 {color: #0000ff;}
    .rsm-ite {display: block;}
    .rsm-indentStart {display:block; margin-left: 30px;}

    .rsm-func {color: blue;}
    .rsm-brafunc {color: darkgreen;}
    /*.rsm-braopen {color: darkgreen;}*/
    /*.rsm-braclose {color: darkgreen;}*/
</style>

<script>
    function isLetter(str) {
      return str != undefined && str.length === 1 && str.match(/[a-z_]/i);
    }

    function getIndicesOf(searchStr, str, caseSensitive) {
      var searchStrLen = searchStr.length;
      if (searchStrLen == 0) {
          return [];
      }
      var startIndex = 0, index, indices = [];
      if (!caseSensitive) {
          str = str.toLowerCase();
          searchStr = searchStr.toLowerCase();
      }
      str = str.trimRight() + ' ';
      while ((index = str.indexOf(searchStr, startIndex)) > -1) {
          indices.push(index);
          startIndex = index + searchStrLen;
      }
      return indices;
    }

    var ie = (typeof document.selection != "undefined" && document.selection.type != "Control") && true;
    var w3 = (typeof window.getSelection != "undefined") && true;

    function getSelectionCharacterOffsetWithin(element) {
      var start = 0;
      var end = 0;
      var doc = element.ownerDocument || element.document;
      var win = doc.defaultView || doc.parentWindow;
      var sel;
      if (typeof win.getSelection != "undefined") {
        sel = win.getSelection();
        if (sel.rangeCount > 0) {
          var range = win.getSelection().getRangeAt(0);
          var preCaretRange = range.cloneRange();
          preCaretRange.selectNodeContents(element);
          preCaretRange.setEnd(range.startContainer, range.startOffset);
          start = preCaretRange.toString().length;
          preCaretRange.setEnd(range.endContainer, range.endOffset);
          end = preCaretRange.toString().length;
        }
      } else if ( (sel = doc.selection) && sel.type != "Control") {
        var textRange = sel.createRange();
        var preCaretTextRange = doc.body.createTextRange();
        preCaretTextRange.moveToElementText(element);
        preCaretTextRange.setEndPoint("EndToStart", textRange);
        start = preCaretTextRange.text.length;
        preCaretTextRange.setEndPoint("EndToEnd", textRange);
        end = preCaretTextRange.text.length;
      }
      return { start: start, end: end };
    }

    function getTextNodesIn(node) {
      var textNodes = [];
      if (node.nodeType == 3) {
        textNodes.push(node);
      } else {
        var children = node.childNodes;
        for (var i = 0, len = children.length; i < len; ++i) {
          textNodes.push.apply(textNodes, getTextNodesIn(children[i]));
        }
      }
      return textNodes;
    }

    function setSelectionRange(el, start, end) {
      if (document.createRange && window.getSelection) {
        var range = document.createRange();
        range.selectNodeContents(el);
        var textNodes = getTextNodesIn(el);
        var foundStart = false;
        var charCount = 0, endCharCount;

        for (var i = 0, textNode; textNode = textNodes[i++]; ) {
          endCharCount = charCount + textNode.length;
          if (!foundStart && start >= charCount
              && (start < endCharCount ||
              (start == endCharCount && i <= textNodes.length))) {
            range.setStart(textNode, start - charCount);
            foundStart = true;
          }
          if (foundStart && end <= endCharCount) {
            range.setEnd(textNode, end - charCount);
            break;
          }
          charCount = endCharCount;
        }

        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      } else if (document.selection && document.body.createTextRange) {
        var textRange = document.body.createTextRange();
        textRange.moveToElementText(el);
        textRange.collapse(true);
        textRange.moveEnd("character", end);
        textRange.moveStart("character", start);
        textRange.select();
      }
    }

    function showCaretDiv() {
      var el = $("#formated_text").get(0);
    }

    $('#formated_text').keyup(showCaretDiv);
    $('#formated_text').mouseup(showCaretDiv);

    document.getElementById("formated_text").addEventListener("input", function() {
      let srcStr = $('#formated_text').text();
      if ( srcStr[srcStr.length-1] != ' ' ) srcStr += ' ';
      let destStr = rsmFormatText(srcStr);
      let el = $("#formated_text").get(0);
      let selection = getSelectionCharacterOffsetWithin(el);
      $('#formated_text').html(destStr);
      setSelectionRange(el, selection.start, selection.start);
    }, false);

    $(document).ready(function(){
      let str;
      // str = "IF 'Test de l''extension'.'Activation 2' = TRUE THEN IF 'Test de l''extension'.'Revenue (positive)' > 0 THEN (('Test de l''extension'.'Revenue (positive)' - 1)+ 2)*3 ELSE IF 1+1 = 2 THEN 1 ELSE 0 ELSE 0";
      // str = "IF x > 0 THEN IF alpha = 1 THEN IF activate THEN TRUE ELSE FALSE ELSE TRUE ELSE FALSE";
      str = "IF x > 0 ";
      // str = '((((1+2)*3)*ROUND(0.5))*5+valueA[LOOKUP:parameterB]';
      $('#formated_text').text(str);
    });


    function rsmFormatText(srcStr){
      var srcStrLen = srcStr.length;

      // highest priority find single quote
      var sQuoteIndices = getIndicesOf("'", srcStr, true);
      var dQuoteIndices = getIndicesOf('"', srcStr, true);
      var sQuoteStarted = false;
      var dQuoteStarted = false;

      var i;
      var quotePairArr = [];
      for ( i = 0; i < srcStrLen; i++ ) {
        if ( !dQuoteStarted && sQuoteIndices.indexOf(i) >= 0 ) {
          quotePairArr.push(i);
          sQuoteStarted = !sQuoteStarted;
        } else if ( !sQuoteStarted && dQuoteIndices.indexOf(i) >= 0 ) {
          quotePairArr.push(i);
          dQuoteStarted = !dQuoteStarted;
        }
      }

      // find if position
      var ifIndices = getIndicesOf("if", srcStr, false);
      var thenIndices = getIndicesOf("then", srcStr, false);
      console.log(srcStr + ':');
      console.log(thenIndices);
      var elseIndices = getIndicesOf("else", srcStr, false);

      var highlights = [];
      var totalParDepth = 0;
      var parFuncDepth = 0;
      var braFuncDepth = 0;
      var curIteDepth = 0;
      var thenStack = [];

      for ( i = 0; i < srcStrLen; i++ ) {
        let quoteOrder = quotePairArr.indexOf(i);
        if ( quoteOrder >= 0 ) {
          if ( quoteOrder < quotePairArr.length ) {
            // if it's not last quote then skip
            i = quotePairArr[quoteOrder + 1];
            continue;
          } else {
            // if last quote then break
            break;
          }
        } else if ( srcStr[i] == '(' ) {
          if ( i > 0 && isLetter(srcStr[i-1]) ) {
            // if parenthesis open, but before letter is character then it is function
            parFuncDepth++;

            let subStr = srcStr.slice(0,i);
            let matches = subStr.match(/[^a-z_][a-z_]+/gi);
            let lastMatch = matches[matches.length-1];
            let pos = subStr.lastIndexOf(lastMatch);

            highlights[pos+1] = {type:"func", len:lastMatch.length-1};
          }

          highlights[i] = {depth:totalParDepth, type:"open", len:1};
          totalParDepth++;
        } else if ( srcStr[i] == ')' ) {
          if (parFuncDepth > 0) {
            parFuncDepth--;
          }

          totalParDepth--;
          highlights[i] = {depth:totalParDepth, type:"close", len:1};
        } else if ( srcStr[i] == '[' ) {
          if ( i > 0 && isLetter(srcStr[i-1]) ) {
            let subStr = srcStr.slice(0,i);
            let matches = subStr.match(/[^a-z_][a-z_]+/gi);
            let lastMatch = matches[matches.length-1];
            let pos = subStr.lastIndexOf(lastMatch);

            highlights[pos+1] = {type:"brafunc", len:lastMatch.length-1};
            highlights[i] = {depth:braFuncDepth, type:"braopen", len:1};
            braFuncDepth++;
          }
        } else if ( srcStr[i] == ']' ) {
          highlights[i] = {depth:braFuncDepth, type:"braclose", len:1};
          braFuncDepth--;
        } else if ( ifIndices.indexOf(i) >= 0 ) {
          let charLen = 2;
          if (i == 0 || i == srcStrLen-charLen || (!isLetter(srcStr[i-1]) && !isLetter(srcStr[i+charLen]) )) {
            highlights[i] = {type:"ite", len:charLen+1, depth:curIteDepth};
            highlights[i+charLen-1] = {type:"indentStart", count:1};
          }

          i += charLen; // for perfomance skip next charLen characters
        } else if ( thenIndices.indexOf(i) >= 0 ) {
          let charLen = 4;
          if (i == 0 || i == srcStrLen-charLen || (!isLetter(srcStr[i-1]) && !isLetter(srcStr[i+charLen]) )) {
            highlights[i-1] = {type:"indentEnd", count:1}; // add indent end tag for if
            highlights[i] = {type:"ite", len:charLen+1, depth:curIteDepth}; // add highlight for then
            highlights[i+charLen-1] = {type:"indentStart", count:1}; // add indent open tag for then
            curIteDepth++; // curIteDepth increase
            thenStack.push(curIteDepth); // add current depth to thenStack
          }

          i += charLen; // for perfomance skip next charLen characters
        } else if ( elseIndices.indexOf(i) >= 0 ) {
          let charLen = 4;
          if (i == 0 || i == srcStrLen-charLen || (!isLetter(srcStr[i-1]) && !isLetter(srcStr[i+charLen]) )) {
            if ( thenStack.length > 0 ) { // validation
              let thenDepth = thenStack.pop(); // pop last then from thenStack
              highlights[i-1] = {type:"indentEnd", count:curIteDepth - thenDepth + 1}; // add indent end tag as much as indent different
              curIteDepth = thenDepth;

              highlights[i] = {type:"ite", len:charLen+1, depth:curIteDepth-1}; // add highlight for then
              highlights[i+charLen-1] = {type:"indentStart", count:1}; // add indent start tag for else
            }
          }
          i += charLen; // for perfomance skip next charLen characters
        }
      }

      // array key reverse
      var keys = new Array();
      for (var k in highlights) {
          keys.unshift(k);
      }

      var destStr = srcStr;
      for (var c = keys.length, n = 0; n < c; n++) {
        var curPos = parseInt(keys[n]);
        var curHighLights = highlights[curPos];
        var curType = curHighLights.type;
        var curLen = curHighLights.len;
        var classStr = 'rsm-highlight';

        if ( curType == "open" || curType == "close" ) {
          var curDepth = curHighLights.depth;
          if ( totalParDepth > 0 ) curDepth -= totalParDepth;
          classStr += ' rsm-bracket rsm-bracket-' + (curDepth < 0 ? 'wrong' : curDepth);
        } else if ( curType == "ite") {
          var curDepth = curHighLights.depth;
          classStr += ' rsm-ite rsm-ite-' + (curDepth < 0 ? 'wrong' : curDepth);
        } else {
          classStr += ' rsm-' + curType;
        }

        if (curType == "indentStart") {
          destStr = [destStr.slice(0, curPos+2), '<span class="' + classStr + '">'.repeat(curHighLights.count), destStr.slice(curPos+2)].join('');
        } else if (curType == "indentEnd") {
          destStr = [destStr.slice(0, curPos+1), '</span>'.repeat(curHighLights.count), destStr.slice(curPos+1)].join('');
        } else {
          destStr = [destStr.slice(0, curPos), '<span class="' + classStr + '">', destStr.slice(curPos,curPos+curLen), '</span>', destStr.slice(curPos+curLen)].join('');
        }
      }

      return destStr;
    };

    /*rsmFormatText();*/
</script>
</body></html>